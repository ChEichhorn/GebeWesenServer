<!DOCTYPE HTML>
	<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /> 
		<title>Heurerika's End. The Invisibility of Correctness</title> 
		<meta name="description" content="Heurerika - The Invisibility of Nowhere">
		
		<script src="script/jquery-min.js" type="text/javascript" charset="utf-8"></script>
		<script src="script/socket.js" type="text/javascript" charset="utf-8"></script>
		
		<script type="text/javascript" charset="utf-8">
		
			// 
			$(function() {
							
				var lastVideo = null,
            isLastVideo = false,
            edgeState = 0; // 0: free, -1: lower, 1: upper

        // Video fade and volume fade helper:
        var setVolume = function(value){
          this.volume = value;
        }

        // Observe the arduinos edges
        $('#intro').on('upper',function(){
          console.warn("Arduino is on upper edge");
          edgeState =  1;
        }).on('free',function(){
          console.log("Arduino is free");
          edgeState =  0;
         }).on('lower',function(){
          console.warn("Arduino is on lower edge");
          edgeState = -1;
        });

        // This RESETs everything:
        var returnToIntro = function(){
          console.warn("RESET!");
          lastVideo = null;
          ws.send("arduino:+");
          ws.send("arduino:r");


          $('video').fadeOut(0,function(){
            // only do this once, a.k.a. on the first element
            this.pause(); // pause all videos! fixed double reset!

            if($(this).is($('video').first())) {
              $('video#intro')[0].volume = 0;
              $('video#intro')[0].play();

              $('video#intro').fadeIn({
                duration: 5000,
                step: setVolume,
                complete: function(){
                  // make sure the arduino is on the upper edge
                  var ok = false;
                  var checkerID;
                  var checker = function(){
                    // check for the arduinos state
                    if(edgeState == 1) {
                      if(checkerID)clearTimeout(checkerID);
                      console.log("RESET complete");
                      return true;
                    } else {
                      console.log("Arduino still in reset progress....");
                      checkerID = setTimeout(checker,1000);
                      return false;
                    }
                  };
                  if (!checker()) checkerID = setTimeout(checker, 1000);
                }
              });
              console.log("RESET in progress!");
            }
          });
          console.log("RESET started!");
          // the ipad should wait after this message until it gets the signal from the arduino,
          // that the start position was reached
          ws.send("ipad:reset");
        }

				// Handle the jumping from one video scene to another
        var upgradeScene = function(){
          var currentVideo = lastVideo,
              $videos = $('video:not(.base)');
          // get the index of the scene videos:
          var index = $videos.index($(currentVideo))
          console.log("Upgrading scene from index: ",index);

          // get the next one
          var nextVideo = $videos.eq(index+1)
          console.log("Next Video is: ", nextVideo);

          // Fall back to null, if we got an empty list
          lastVideo = nextVideo.size()>0 ? nextVideo[0] : null;
          isLastVideo = $videos.last().is(nextVideo);

          console.log("Current Video is last video?",(isLastVideo ? "yes" : "no"));

          if(lastVideo!=null) ws.send("arduino:-");
        }

        // Start was pressed:
				$('video#intro').on("start",function() {
  				console.log("start!");
          ws.send("ipad:blackout");
					$(this).fadeOut({
            duration: 'slow',
            step: setVolume,
            complete: function(){
						  this.pause(); this.currentTime = 0;
					  	$('video#1')[0].currentTime = 0;
						  $('video#1')[0].play();
					  	$('video#1').fadeIn('slow');
					  	lastVideo = $('video#1')[0];
            }
					});
				});
				
        // Each video observes its currentTime
        $('video:not(.base)').on("timeupdate",function() {
          var isFading   = $(this).hasClass("fading");
          var endReached = this.currentTime >= parseInt($(this).data("duration"));
  				if( endReached && !isFading && !this.paused ) {
            $(this).addClass("fading");
						$(this).fadeOut('slow', function() {
              $(this).removeClass("fading");
              this.pause();
              ws.send("arduino:#");
							ws.send("ipad:ready");
              if(isLastVideo){
                // simply trigger the reset
                returnToIntro();
              } else {
							  $('video#pulse')[0].currentTime = 0;
							  $('video#pulse')[0].play();
							  $('video#pulse').fadeIn('slow');
              }
						});
					}
				});
				
				$('video#pulse').on("timeupdate",function(){
					if(this.currentTime>=this.duration && this.paused) {
						$(this).fadeOut('slow',function(){
							if (lastVideo == null) {
                // returnToIntro();
                console.error("Pulse video did run on last video! Reset mus be triggered manually.");
						  } else {
								lastVideo.currentTime = 0;
								lastVideo.play();
								$(lastVideo).fadeIn('slow');
								ws.send("ipad:blackout");
                
							}
						});
					}
				})
				
				$('video#pulse').on("change continue",function(event) {
          console.log("pulse reacting on :", event.type);
					if(this.paused) return;
					
          ws.send("ipad:blackout");
					$(this).fadeOut('slow');
					
					switch(event.type) {
						case "change":
							// do nothing, lastVideo does not change, so we can play it again (sam)
              console.log("user pressed change, playing same scene again",lastVideo);
							break;
						case "continue":
              console.log("user pressed continue, upgrading scene");
              upgradeScene();
							break;
					}
					$(this).fadeOut('slow',function(){
            this.pause(); // Pause the pulse
            if(lastVideo == null) {
              console.warn("lastVideo not set, returning to intro!");
              returnToIntro();
              return;
            }
						lastVideo.currentTime = 0;
						lastVideo.play();
						$(lastVideo).fadeIn('slow');
					});
				});
				
				$('#up').on("click",function(){
					ws.send("arduino:+")
				})
				
				$('#down').on("click",function(){
					ws.send("arduino:-")
				})
				
				$('#stop').on("click",function(){
					ws.send("arduino:#")
				})

        // Kick it off:
        $('video:not(:first-child)').fadeOut(0);
				initSocket("video",returnToIntro, '#intro,#pulse');
				
			})	
		</script>
		
		<link rel="stylesheet" href="styles/video.css" type="text/css" media="screen" title="no title" charset="utf-8">
		
	</head>
	<body>
		<div id="controls">
			<button id="up">+</button>
			<button id="down">-</button>
			<button id="stop">#</button>
		</div>

		<div id="videos">
			<video class="base" id="intro" src="vids/Intro.mp4" type="video/mp4" autobuffer loop ></video>
			<video class="base" id="pulse" src="vids/Pulse.mp4" type="video/mp4" autobuffer></video>
			
      <!-- Scenes -->
	    <video id="1" data-duration="5" src="vids/1.mp4" type="video/mp4" autobuffer></video>
			<video id="2" data-duration="5" src="vids/2.mp4" type="video/mp4" autobuffer></video>
			<video id="3" data-duration="5" src="vids/3.mp4" type="video/mp4" autobuffer></video>
			<video id="4" data-duration="5" src="vids/4.mp4" type="video/mp4" autobuffer></video>
			<video id="5" data-duration="5" src="vids/5.mp4" type="video/mp4" autobuffer></video>
		</div>
	</body>
</html>
