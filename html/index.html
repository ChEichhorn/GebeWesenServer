<!DOCTYPE HTML>
	<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /> 
		<title>Heurerika's End. The Invisibility of Correctness</title> 
		<meta name="description" content="Heurerika - The Invisibility of Nowhere">
		
		<script src="script/jquery-min.js" type="text/javascript" charset="utf-8"></script>
		<script src="script/socket.js" type="text/javascript" charset="utf-8"></script>
		
		<script type="text/javascript" charset="utf-8">
		
			// 
			$(function() {
							
				var lastVideo = null,
            isLastVideo = false,
            fadeTime = 500,
            autoFromID = 3,
            transportTime = 20, // Time in seconds the lift decends
            edgeState = 0; // 0: free, -1: lower, 1: upper

        // Video fade and volume fade helper:
        var setVolume = function(value){
          this.volume = value;
        }

        // Observe the arduinos edges
        $('#intro').on('upper',function(){
          console.warn("Arduino is on upper edge");
          edgeState =  1;
        }).on('free',function(){
          console.log("Arduino is free");
          edgeState =  0;
         }).on('lower',function(){
          console.warn("Arduino is on lower edge");
          edgeState = -1;
        });

        // This RESETs everything:
        var returnToIntro = function(){
          console.warn("RESET!");
          lastVideo = null;
          isLastVideo = false;
          ws.send("arduino:+");
          ws.send("arduino:r");

          $('video:not(.base)').removeClass('stopped'); // remove the lift control class from all videos

          $('video').fadeOut(0,function(){
            // only do this once, a.k.a. on the first element
            this.pause(); // pause all videos! fixed double reset!

            if($(this).is($('video').first())) {
              $('video#intro')[0].volume = 0;
              $('video#intro')[0].play();

              $('video#intro').fadeIn({
                duration: 5000,
                step: setVolume,
                complete: function(){
                  // make sure the arduino is on the upper edge
                  var ok = false;
                  var checkerID;
                  var checker = function(){
                    // check for the arduinos state
                    if(edgeState == 1) {
                      if(checkerID)clearTimeout(checkerID);
                      ws.send('ipad:unlock');
                      ws.send('ipad:reset');
                      console.log("RESET complete");
                      return true;
                    } else {
                      console.log("Arduino still in reset progress....");
                      ws.send("arduino:r");
                      checkerID = setTimeout(checker,1000);
                      return false;
                    }
                  };
                  if (!checker()) checkerID = setTimeout(checker, 1000);
                }
              });
              console.log("RESET in progress!");
            }
          });
          console.log("RESET started!");
          // the ipad should wait after this message until it gets the signal from the arduino,
          // that the start position was reached
          ws.send("ipad:blackout");
        }

        // Start was pressed:
				$('video#intro').on("start",function() {
  				console.log("********* Start!");
          ws.send("ipad:blackout");
					$(this).fadeOut({
            duration: fadeTime,
            step: setVolume,
            complete: function(){
						  this.pause(); this.currentTime = 0;
					  	$('video#1')[0].currentTime = 0;
						  $('video#1')[0].play();
					  	$('video#1').fadeIn(fadeTime);
					  	lastVideo = $('video#1')[0];
            }
					});
				});
				
        // Each video observes its currentTime
        $('video:not(.base)').on("timeupdate",function() {
          var cvid = getCurrentVideoID();
          

          // controll the lift:
          var isStopped = $(this).hasClass('stopped');
          if(this.currentTime >= transportTime && !isStopped) {
            ws.send('arduino:#');
            $(this).addClass('stopped');
          }
          
          // controll the video itself
          var isFading   = $(this).hasClass("fading");
          var endReached = this.currentTime >= this.duration-(fadeTime/1000.0); //parseInt($(this).data("duration"));
          // console.log(this.currentTime,this.duration,this.duration-this.currentTime,endReached);
  				if( endReached && !isFading ) { //&& !this.paused ) {
            $(this).addClass("fading");
						$(this).fadeOut(fadeTime, function() {
              $(this).removeClass("fading");
              this.pause();
              if (cvid<4) ws.send("arduino:#");
							
              ws.send("ipad:ready");
              if(cvid>=5){
                // simply trigger the reset
                // upgradeScene(); // make sure the video selection is updated too
                returnToIntro();
              }
              else if(cvid==4) {
                $('#pulse').trigger('continue');
              }
              else {
							  $('video#pulse')[0].currentTime = 0;
							  $('video#pulse')[0].play();
							  $('video#pulse').fadeIn(fadeTime);
              }
						});
					}
				});
				
        // Scene management happens through the #pulse
				// Handle the jumping from one video scene to another
        var upgradeScene = function(){
          var currentVideo = lastVideo,
              $videos = $('video:not(.base)');
          // get the index of the scene videos:
          var index = $videos.index($(currentVideo))

          console.log("Upgrading scene from index: ",index);

          // get the next one
          var nextVideo = $videos.eq(index+1)

          console.log("Next Video is: ", nextVideo.attr("id"));

          // Fall back to null, if we got an empty list
          lastVideo = nextVideo.size()>0 ? nextVideo[0] : null;
          isLastVideo = $videos.last().is(nextVideo);
          
          console.log("Next video is last video?",(isLastVideo ? "yes" : "no"));

          if(getCurrentVideoID() >= autoFromID) {
            console.log("Upgraded scene is in automatic domain, sending a lock");
            ws.send('ipad:lock');
          }

          if(lastVideo!=null) ws.send("arduino:-");
        }

        var getCurrentVideoID = function(){
          return lastVideo!=null ? parseInt($(lastVideo).attr("id"),10) : -1
        }

				$('video#pulse').on("timeupdate",function(){
					if(this.currentTime>=this.duration && this.paused) {

						$(this).fadeOut(fadeTime,function(){
							if (lastVideo == null) {
                // returnToIntro();
                console.error("#Pulse video did run on last video! Reset mus be triggered manually.");
						  } else {
                var cvidID = getCurrentVideoID();
                console.log("Current Video ID is",cvidID);
                if(cvidID >= autoFromID) {
                  // trigger automatically
                  console.log("Triggering automatically");
                  ws.send('ipad:lock');
                  $(this).trigger('continue');
                } 
                else {
								  ws.send("ipad:blackout");
                  $(this).trigger('change');
                }
							}
						});

					}
				});
				
				$('video#pulse').on("change continue",function(event) {
          console.log("pulse reacting on :", event.type);
					if(!this.paused) this.pause();
					
          ws.send("ipad:blackout");
					$(this).fadeOut('slow');
					
					if(event.type == "change") {
							// do nothing, lastVideo does not change, so we can play it again (sam)
              console.log("Change triggered: playing same scene again");
					}
          else if(event.type == "continue") {
              console.log("Continue triggered: upgrading scene");
              upgradeScene();
					}
          
					$(this).fadeOut(fadeTime,function(){
            this.pause(); // Pause the pulse
            if(lastVideo == null) {
              console.error("lastVideo not set, returning to intro!");
              returnToIntro();
              return;
            }

						lastVideo.currentTime = 0;
					  lastVideo.play();
            $('video:not(.base)').removeClass('stopped'); // remove the lift control class from all videos
						$(lastVideo).fadeIn(fadeTime);
					});
				});
				

        // Button actions for debugging:
				$('#up').on("click",function(){
					ws.send("arduino:+")
				})
				
				$('#down').on("click",function(){
					ws.send("arduino:-")
				})
				
				$('#stop').on("click",function(){
					ws.send("arduino:#")
				})

        // Kick it off:
        $('video:not(#intro)').fadeOut(0);
				initSocket("video",returnToIntro, '#intro,#pulse');
				
			})	
		</script>
		
		<link rel="stylesheet" href="styles/video.css" type="text/css" media="screen" title="no title" charset="utf-8">
		
	</head>
	<body>
		<div id="controls">
			<button id="up">+</button>
			<button id="down">-</button>
			<button id="stop">#</button>
		</div>

		<div id="videos">
			<video class="base" id="intro" src="vids/Intro.mp4" type="video/mp4" autobuffer loop ></video>
			<video class="base" id="pulse" src="vids/Pulse.mp4" type="video/mp4" autobuffer></video>
			
      <!-- Scenes -->
	    <video id="1" data-duration="45" src="vids/1.mp4" type="video/mp4" autobuffer></video>
			<video id="2" data-duration="45" src="vids/2.mp4" type="video/mp4" autobuffer></video>
			<video id="3" data-duration="45" src="vids/3.mp4" type="video/mp4" autobuffer></video>
			<video id="4" data-duration="45" src="vids/4.mp4" type="video/mp4" autobuffer></video>
			<video id="5" data-duration="45" src="vids/5.mp4" type="video/mp4" autobuffer></video>
		</div>
	</body>
</html>
